#include <BLEDevice.h>
#include <BLEServer.h>
#include <WiFi.h>

const char* ssid = "Zyxel_D9B1";
const char* password = "UNHTF48UEY";
const char* serverUrl = "http://192.168.1.140:8081/update-location"; // Replace with your server URL
const char* deviceName = "MobileESP32"; // Your device's name
const uint16_t customServiceUUID = 0x1234; // Replace with your custom service UUID (Universally Unique Identifier)

BLEAdvertising* pAdvertising;

void setup() {
    Serial.begin(115200);
    setupBLE();
    setupWiFi();
}

void setupBLE() {
    BLEDevice::init(deviceName);
    pAdvertising = BLEDevice::getAdvertising();
    pAdvertising->setScanResponse(false);
    pAdvertising->setMinPreferred(0x06);
    pAdvertising->setMinPreferred(0x12);
    pAdvertising->addServiceUUID(customServiceUUID);
    // Add other advertisement data as needed
    BLEDevice::startAdvertising();
}

void setupWiFi() {
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.println("Connecting to WiFi...");
    }
    Serial.println("Connected to WiFi");
}

void loop() {
    // Obtain location data (e.g., GPS coordinates)
    float latitude = getLatitude();
    float longitude = getLongitude();
    
    // Send location data to the server via HTTP
    sendLocationData(latitude, longitude);

    // Delay for a period before the next data transmission
    delay(5000); // Adjust the delay time as needed
}

float getLatitude() {
    // Implement code to obtain latitude data (e.g., from GPS)
    return 0.0; // Replace with actual latitude value
}

float getLongitude() {
    // Implement code to obtain longitude data (e.g., from GPS)
    return 0.0; // Replace with actual longitude value
}

void sendLocationData(float latitude, float longitude) {
    String postData = "latitude=" + String(latitude) + "&longitude=" + String(longitude);
    HTTPClient http;
    http.begin(serverUrl);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");
    int httpResponseCode = http.POST(postData);
    
    if (httpResponseCode == HTTP_CODE_OK) {
        Serial.println("Data sent to server successfully");
    } else {
        Serial.print("Error sending data to server. Error code: ");
        Serial.println(httpResponseCode);
    }
    
    http.end();
    
}
